# OCR服务器端口自定义功能指南

## 功能概述

OCR服务器现在支持自定义端口和自动端口检测功能，让您可以根据需要灵活配置服务器端口。

## 主要功能

### 1. 自定义端口
- 支持通过命令行参数指定端口号
- 支持指定主机地址
- 端口号范围：1-65535

### 2. 端口占用检测
- 启动前自动检测指定端口是否被占用
- 当端口被占用时提供清晰的错误提示
- 支持自动查找可用端口功能

### 3. 自动端口功能
- 使用 `--auto-port` 参数启用自动端口查找
- 当指定端口被占用时，自动查找下一个可用端口
- 最多尝试100个连续端口

## 使用方法

### 基本用法

```bash
# 使用默认端口8080
./ocr_server

# 指定端口9000
./ocr_server -p 9000

# 指定主机和端口
./ocr_server -H 0.0.0.0 -p 9000

# 显示帮助信息
./ocr_server --help
```

### 端口占用处理

```bash
# 当端口被占用时，程序会报错并退出
./ocr_server -p 8080
# 输出: ❌ 错误: 端口 8080 已被占用
#       💡 提示: 使用 --auto-port 参数自动查找可用端口

# 使用自动端口功能
./ocr_server -p 8080 --auto-port
# 输出: ⚠️  端口 8080 已被占用，正在查找可用端口...
#       ✅ 找到可用端口: 8081
```

### 启动脚本用法

```bash
# 使用启动脚本（Linux/Mac）
./start.sh -p 9000
./start.sh --auto-port

# 使用启动脚本（Windows）
start.bat -p 9000
start.bat --auto-port
```

## 命令行参数

| 参数 | 短参数 | 说明 | 默认值 |
|------|--------|------|--------|
| `--port` | `-p` | 服务器端口号 | 8080 |
| `--host` | `-H` | 服务器主机地址 | localhost |
| `--auto-port` | - | 自动查找可用端口 | 关闭 |
| `--help` | `-h` | 显示帮助信息 | - |
| `--version` | - | 显示版本信息 | - |

## 使用场景

### 1. 开发环境
```bash
# 使用默认端口
./ocr_server

# 使用特定端口避免冲突
./ocr_server -p 9000
```

### 2. 生产环境
```bash
# 绑定到所有网络接口
./ocr_server -H 0.0.0.0 -p 8080

# 使用自动端口功能避免冲突
./ocr_server -H 0.0.0.0 -p 8080 --auto-port
```

### 3. 多实例部署
```bash
# 实例1
./ocr_server -p 8080

# 实例2（自动选择可用端口）
./ocr_server -p 8080 --auto-port

# 实例3（指定不同端口）
./ocr_server -p 9000
```

## 错误处理

### 端口被占用
```
❌ 错误: 端口 8080 已被占用
💡 提示: 使用 --auto-port 参数自动查找可用端口
```

### 端口号无效
```
❌ 错误: 端口号必须在1-65535之间，当前值: 99999
```

### 找不到可用端口
```
❌ 错误: 在端口 8080 附近未找到可用端口
```

## 技术实现

### 端口检测原理
1. 使用socket连接测试端口是否被占用
2. 设置1秒超时避免长时间等待
3. 支持IPv4和IPv6地址

### 自动端口查找
1. 从指定端口+1开始查找
2. 最多尝试100个连续端口
3. 返回第一个可用端口

### 安全考虑
- 端口号范围限制：1-65535
- 超时机制防止长时间阻塞
- 错误处理确保程序稳定运行

## 注意事项

1. **权限要求**：某些端口（如1024以下）可能需要管理员权限
2. **防火墙设置**：确保防火墙允许指定端口的访问
3. **网络配置**：使用 `0.0.0.0` 绑定所有接口时注意网络安全
4. **端口冲突**：在生产环境中建议使用 `--auto-port` 功能

## 更新日志

- **v1.1**: 新增端口自定义功能
- **v1.2**: 新增端口占用检测功能
- **v1.3**: 新增自动端口查找功能 